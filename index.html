<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PLFC ‚Äì Solunar & Conditions (Point Lookout ‚Ä¢ Amity ‚Ä¢ Dunwich ‚Ä¢ Jumpinpin)</title>
  <meta name="description" content="Single‚Äëfile, host-anywhere solunar and marine conditions app for Minjerribah (North Stradbroke Island) hotspots. 15‚Äëminute auto refresh. All metric." />
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#93a1bd; --text:#e6eefc; --accent:#33d6a6; --warn:#ffb020; --danger:#ff6b6b;
      --border:#1d2840;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.7));backdrop-filter:saturate(1.2) blur(8px);}    
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media (max-width:900px){.row,.row-3,.row-4{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:20px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 8px;color:var(--muted)}
    h3{font-size:14px;margin:0 0 6px;color:var(--muted)}
    .muted{color:var(--muted)}
    select, input, button{background:#0c1529;color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:12px}
    button{cursor:pointer}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border); background:#0e1a32; font-size:12px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .kpi{font-size:22px;font-weight:700}
    .kpi-sub{font-size:12px;color:var(--muted)}
    .ok{color:var(--accent)} .warn{color:var(--warn)} .bad{color:var(--danger)}
    .footer{opacity:.7;font-size:12px;text-align:center;padding:20px}
    .tag{font-size:12px;opacity:.9}
    .map-toggle{display:flex;gap:8px;align-items:center; flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .small{font-size:13px}
    .notice{border-left:3px solid var(--accent); padding-left:10px; color:var(--muted)}
    a{color:#7bb6ff}
    .card canvas { display:block; width:100%; height:180px !important; max-height:220px; }
  </style>
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap flex">
      <div>
        <h1>üé£ PLFC Solunar & Conditions</h1>
        <div class="muted small">Point Lookout ‚Ä¢ Amity Point ‚Ä¢ Dunwich ‚Ä¢ Jumpinpin ‚Äî updates every <span id="refresh-interval">15</span> min</div>
      </div>
      <div class="grow"></div>
      <div class="flex">
        <label class="sr-only" for="location">Location</label>
        <select id="location"></select>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="app">
    <div class="row">
      <section class="card">
        <div class="section-title">
          <h2>Google My Maps</h2>
          <div class="map-toggle small">Layer:
            <button class="pill" data-map-layer="all">All</button>
            <button class="pill" data-map-layer="point-lookout">Point Lookout</button>
            <button class="pill" data-map-layer="amity">Amity</button>
            <button class="pill" data-map-layer="dunwich">Dunwich</button>
            <button class="pill" data-map-layer="jumpinpin">Jumpinpin</button>
          </div>
        </div>
        <div class="notice small">This iframe uses a My‚ÄëMaps <em>mid</em>. Replace <code>1pZdqmQfqAUfK53FadLULB_5mQ0qC0iY</code> below with your shared map ID. Layer buttons change the <em>ll</em> and <em>z</em> params to jump around hotspots.</div>
        <div style="aspect-ratio:16/9; margin-top:8px">
          <iframe id="mymaps" title="PLFC Spots" width="100%" height="100%" style="border:0;border-radius:12px" allowfullscreen
            src="https://www.google.com/maps/d/embed?mid=1pZdqmQfqAUfK53FadLULB_5mQ0qC0iY&ehbc=2E312F&ll=-27.4310,153.5470&z=11"></iframe>
        </div>
      </section>

      <section class="card">
        <div class="section-title"><h2>Solunar Bite Windows</h2><span class="pill" id="moon-phase-pill">‚Äî</span></div>
        <div id="solunar">
          <div class="row-4">
            <div>
              <div class="kpi" id="major-1">‚Äî</div>
              <div class="kpi-sub">Major 1</div>
            </div>
            <div>
              <div class="kpi" id="major-2">‚Äî</div>
              <div class="kpi-sub">Major 2</div>
            </div>
            <div>
              <div class="kpi" id="minor-1">‚Äî</div>
              <div class="kpi-sub">Minor 1</div>
            </div>
            <div>
              <div class="kpi" id="minor-2">‚Äî</div>
              <div class="kpi-sub">Minor 2</div>
            </div>
          </div>
          <div class="row-3" style="margin-top:10px">
            <div>
              <div class="kpi" id="sunrise">‚Äî</div>
              <div class="kpi-sub">Sunrise</div>
            </div>
            <div>
              <div class="kpi" id="sunset">‚Äî</div>
              <div class="kpi-sub">Sunset</div>
            </div>
            <div>
              <div class="kpi" id="moon-illum">‚Äî</div>
              <div class="kpi-sub">Moon Illumination</div>
            </div>
          </div>
          <div class="small muted" id="solunar-note" style="margin-top:8px"></div>
        </div>
      </section>
    </div>

    <div class="row" style="margin-top:16px">
      <section class="card">
        <div class="section-title"><h2>Waves ‚Äî Swell vs Wind‚Äëwave</h2><span class="pill">24h</span></div>
        <canvas id="waveBreakChart" height="120"></canvas>
        <table id="marineBreakTable" style="margin-top:8px">
          <thead><tr><th>Time</th><th>Swell H (m)</th><th>Swell T (s)</th><th>Wind‚Äëwave H (m)</th><th>Wind‚Äëwave T (s)</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </div>

    <div class="row" style="margin-top:16px">
      <section class="card">
        <div class="section-title"><h2>Weather & Wind (Open‚ÄëMeteo)</h2><span class="pill" id="updated-weather">‚Äî</span></div>
        <canvas id="wxChart" height="120"></canvas>
        <table id="wxTable" style="margin-top:8px">
          <thead><tr><th>Time</th><th>Temp (¬∞C)</th><th>Wind (km/h)</th><th>Gust (km/h)</th><th>Dir (¬∞)</th><th>RH %</th><th>Rain %</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card">
        <div class="section-title"><h2>Waves (Marine)</h2><span class="pill" id="updated-marine">‚Äî</span></div>
        <canvas id="waveChart" height="120"></canvas>
        <table id="marineTable" style="margin-top:8px">
          <thead><tr><th>Time</th><th>Hs (m)</th><th>Period (s)</th><th>Dir (¬∞)</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </div>

    <div class="row" style="margin-top:16px">
      <section class="card">
        <div class="section-title"><h2>Tides (WorldTides)</h2><span class="pill" id="updated-tides">Requires API key</span></div>
        <div class="flex">
          <input id="worldtidesKey" placeholder="WorldTides API Key (saved locally)" class="grow" />
          <button id="saveKey">Save</button>
        </div>
        <table id="tideTable" style="margin-top:8px">
          <thead><tr><th>Time</th><th>Type</th><th>Height (m)</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="small muted">Tip: get a key at worldtides.info (global predictions). Key is stored in your browser only.</div>
      </section>

      <section class="card">
        <div class="section-title"><h2>Precipitation Nowcast (15‚Äëmin)</h2><span class="pill" id="updated-precip">‚Äî</span></div>
        <canvas id="precip15Chart" height="120"></canvas>
      </section>

      <section class="card">
        <div class="section-title"><h2>Now</h2><span class="pill" id="now-local">‚Äî</span></div>
        <div class="grid">
          <div>
            <h3>Location</h3>
            <div id="locName" class="kpi">‚Äî</div>
            <div class="kpi-sub" id="locCoords">‚Äî</div>
          </div>
          <div>
            <h3>Quick Read</h3>
            <div id="quickRead" class="small"></div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>APIs & Refresh</h2>
      <div class="small muted">We refresh every 15 minutes by default. You can change the interval below.</div>
      <div class="flex" style="margin-top:8px">
        <label>Refresh (minutes): <input id="refreshMins" type="number" min="1" max="60" value="15" style="width:90px"></label>
        <button id="applyRefresh">Apply</button>
      </div>
      <div class="row-4" style="margin-top:10px">
        <div><h3>Solunar</h3><div class="tag"><a target="_blank" href="https://api.solunar.org">api.solunar.org</a> (no key)</div></div>
        <div><h3>Weather</h3><div class="tag"><a target="_blank" href="https://open-meteo.com/en/docs">Open‚ÄëMeteo</a> (no key)</div></div>
        <div><h3>Marine</h3><div class="tag"><a target="_blank" href="https://open-meteo.com/en/docs/marine-api">Open‚ÄëMeteo Marine</a> (no key)</div></div>
        <div><h3>Tides</h3><div class="tag"><a target="_blank" href="https://www.worldtides.info/developer">WorldTides</a> (key) ‚Ä¢ Alt: <a target="_blank" href="https://stormglass.io">Stormglass</a></div></div>
      </div>
    </section>

    <div class="footer">Built with ‚ù§ for the Point Lookout Fishing Club. Host this single file on GitHub Pages and you're off. ‚Äî Finnius, your Fishing Mate üêü</div>
  </main>

  <!-- App JS (separate tag so the Chart.js loader above can truly defer) -->
  <script>
// ====== HELPERS & PARSERS ======
function parseSolunarTime(dateISO,t){
  if(!t) return null;
  t=String(t).trim().toLowerCase();
  const [hm,ap='']=t.split(/\s+/);
  const [hh,mm]=hm.split(':'); if(!hh||!mm) return null;
  let h=+hh,m=+mm; if(Number.isNaN(h)||Number.isNaN(m)) return null;
  if(ap==='pm'&&h<12) h+=12; if(ap==='am'&&h===12) h=0;
  const d=new Date(`${dateISO}T${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:00`);
  return Number.isNaN(d.getTime())?null:d;
}

// ====== CONFIG ======
const LOCATIONS={
  "Point Lookout":{lat:-27.4310,lon:153.5347,layer:"point-lookout"},
  "Amity Point":  {lat:-27.4019,lon:153.4393,layer:"amity"},
  "Dunwich":      {lat:-27.4993,lon:153.4011,layer:"dunwich"},
  "Jumpinpin":    {lat:-27.7340,lon:153.4480,layer:"jumpinpin"}
};
const DEFAULT_LOC="Point Lookout";
const TZ=Intl.DateTimeFormat().resolvedOptions().timeZone||"Australia/Brisbane";
let REFRESH_MS=15*60*1000;

// ====== UTIL ======
const el=(id)=>document.getElementById(id);
const fmtTime=(d)=>new Date(d).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
const fmtDateTime=(d)=>new Date(d).toLocaleString([], {hour:"2-digit",minute:"2-digit",day:"2-digit",month:"short"});
const toISODate=(d)=>new Date(d).toISOString().slice(0,10);
const toSolunarDate=d=>{const dt=new Date(d);const y=dt.getFullYear();const m=String(dt.getMonth()+1).padStart(2,'0');const day=String(dt.getDate()).padStart(2,'0');return `${y}${m}${day}`;};
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,fb)=>{try{return JSON.parse(localStorage.getItem(k))??fb;}catch{return fb;}};

// ====== INIT UI ======
(function initUI(){
  try{
    const sel=el('location'); sel.innerHTML='';
    Object.keys(LOCATIONS).forEach(name=>{const o=document.createElement('option');o.value=name;o.textContent=name;sel.appendChild(o);});
    const saved=load('plfc.loc',DEFAULT_LOC); sel.value=LOCATIONS[saved]?saved:DEFAULT_LOC;

    const savedRefresh=Number(load('plfc.refresh',REFRESH_MS))||REFRESH_MS;
    el('worldtidesKey').value=load('plfc.worldtides','');
    el('refreshMins').value=Math.max(1,Math.min(60,Math.round(savedRefresh/60000)));
    el('refresh-interval').textContent=Math.round(savedRefresh/60000);
    REFRESH_MS=savedRefresh;

    sel.addEventListener('change',()=>{save('plfc.loc',sel.value); updateAll(); recenterMyMaps();});
    el('saveKey').addEventListener('click',()=>{save('plfc.worldtides',el('worldtidesKey').value.trim()); updateTides();});
    el('applyRefresh').addEventListener('click',()=>{
      const mins=clamp(parseInt(el('refreshMins').value||'15',10),1,60);
      REFRESH_MS=mins*60*1000; save('plfc.refresh',REFRESH_MS);
      el('refresh-interval').textContent=mins; scheduleAutoRefresh();
    });
    el('refreshBtn').addEventListener('click',()=>updateAll());
    document.querySelectorAll('[data-map-layer]').forEach(btn=>btn.addEventListener('click',()=>centerToLayer(btn.dataset.mapLayer)));
  }catch(err){ console.error('UI init failed',err); try{el('location').value=DEFAULT_LOC;}catch{} }
})();
function currentLoc(){ const name=(el('location')?.value)||DEFAULT_LOC; return LOCATIONS[name]||LOCATIONS[DEFAULT_LOC]; }
function updateNow(){ el('now-local').textContent=new Date().toLocaleString(); }

// ====== GOOGLE MY MAPS ======
function recenterMyMaps(){
  const {lat,lon}=currentLoc();
  const url=new URL(el('mymaps').src);
  url.searchParams.set('ll',`${lat.toFixed(5)},${lon.toFixed(5)}`);
  url.searchParams.set('z','12');
  el('mymaps').src=url.toString();
}
function centerToLayer(layer){
  if(layer==='all'){ el('mymaps').src=el('mymaps').src; return; }
  const entry=Object.entries(LOCATIONS).find(([,v])=>v.layer===layer);
  if(entry){ el('location').value=entry[0]; save('plfc.loc',entry[0]); recenterMyMaps(); updateAll(); }
}

// ====== FETCHERS ======
async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

async function getSolunar(lat, lon, dateISO){
  const tzHours = -new Date().getTimezoneOffset()/60; // e.g. +10 for Brisbane
  const endpoints = [
    `https://api.solunar.org/solunar/${lat},${lon},${dateISO},${tzHours}`,
    // CORS/text proxies fallback (try a couple)
    `https://r.jina.ai/http://api.solunar.org/solunar/${lat},${lon},${dateISO},${tzHours}`,
    `https://cors.isomorphic-git.org/http://api.solunar.org/solunar/${lat},${lon},${dateISO},${tzHours}`
  ];
  for (const url of endpoints){
    try{
      const r = await fetch(url);
      const txt = await r.text();
      // jina returns text; direct returns JSON ‚Äî handle both
      const data = typeof txt === 'string' ? JSON.parse(txt) : await r.json();
      // sanity check: must have at least one of these keys
      const ok = data && (data.major1Start || data.minor1Start || data.sunRise || data.moonPhase !== undefined);
      if (ok) return data;
    }catch(e){ /* try next endpoint */ }
  }
  return null; // we‚Äôll fall back to Open-Meteo sunrise/sunset
}

async function getWeather(lat,lon){
  const url=new URL('https://api.open-meteo.com/v1/forecast');
  url.search=new URLSearchParams({
    latitude:lat, longitude:lon, timezone:TZ||'auto',
    temperature_unit:'celsius', wind_speed_unit:'kmh', precipitation_unit:'mm',
    hourly:['temperature_2m','wind_speed_10m','wind_gusts_10m','wind_direction_10m','relative_humidity_2m','precipitation_probability'].join(','),
    daily:['sunrise','sunset','uv_index_max','moon_phase'].join(','),
    minutely_15:'precipitation'
  }).toString();
  return fetchJSON(url);
}

function offshore(lat,lon,km=2,bearingDeg=100){
  const R=6371, br=bearingDeg*Math.PI/180, d=km/R, la=lat*Math.PI/180, lo=lon*Math.PI/180;
  const la2=Math.asin(Math.sin(la)*Math.cos(d)+Math.cos(la)*Math.sin(d)*Math.cos(br));
  const lo2=lo+Math.atan2(Math.sin(br)*Math.sin(d)*Math.cos(la),Math.cos(d)-Math.sin(la)*Math.sin(la2));
  return {lat:la2*180/Math.PI, lon:((lo2*180/Math.PI+540)%360)-180};
}
async function getMarine(lat,lon){
  const sea=offshore(lat,lon,2,100);
  const url=new URL('https://marine-api.open-meteo.com/v1/marine');
  url.search=new URLSearchParams({
    latitude:sea.lat, longitude:sea.lon, timezone:TZ||'auto',
    hourly:['wave_height','wave_direction','wave_period','wind_wave_height','wind_wave_direction','wind_wave_period','swell_wave_height','swell_wave_direction','swell_wave_period'].join(',')
  }).toString();
  return fetchJSON(url);
}

async function getTides(lat,lon){
  const key=el('worldtidesKey').value.trim();
  if(!key){ el('updated-tides').textContent='Add API key to show tides'; return {extremes:[]}; }
  const url=new URL('https://www.worldtides.info/api');
  url.search=new URLSearchParams({extremes:'',lat,lon,key,length:48*3600}).toString();
  const data=await fetchJSON(url);
  el('updated-tides').textContent='Updated '+new Date(data.creationDate||Date.now()).toLocaleString();
  return data;
}

// ====== RENDER ======
let wxChart,waveChart,precipChart,waveBreakChart;
function destroyCharts(){
  try{wxChart?.destroy()}catch{} wxChart=null;
  try{waveChart?.destroy()}catch{} waveChart=null;
  try{precipChart?.destroy()}catch{} precipChart=null;
  try{waveBreakChart?.destroy()}catch{} waveBreakChart=null;
}
function phaseName(idx){
  if(typeof idx==='string') return idx;
  const names=['New','Waxing Crescent','First Quarter','Waxing Gibbous','Full','Waning Gibbous','Last Quarter','Waning Crescent'];
  return names[clamp(Math.round(idx||0),0,7)]||'‚Äî';
}
function fillFromWeatherDaily(daily){
  if(!daily) return;
  if(daily.sunrise?.[0]) el('sunrise').textContent=fmtTime(daily.sunrise[0]);
  if(daily.sunset?.[0])  el('sunset').textContent=fmtTime(daily.sunset[0]);
  if(typeof daily.moon_phase?.[0]==='number'){
    const phase=daily.moon_phase[0];
    const illum=0.5*(1-Math.cos(2*Math.PI*phase));
    el('moon-illum').textContent=Math.round(illum*100)+'%';
    el('moon-phase-pill').textContent=phaseName(Math.round((phase%1)*8));
  }
}
function renderSolunar(data){
  const show=(id,start,end)=>{ const x=el(id); x.textContent=(start&&end)?`${fmtTime(start)} ‚Äì ${fmtTime(end)}`:'‚Äî'; };
  show('major-1',data.major1Start,data.major1End);
  show('major-2',data.major2Start,data.major2End);
  show('minor-1',data.minor1Start,data.minor1End);
  show('minor-2',data.minor2Start,data.minor2End);
  el('sunrise').textContent=data.sunRise?fmtTime(data.sunRise):el('sunrise').textContent||'‚Äî';
  el('sunset').textContent =data.sunSet ?fmtTime(data.sunSet) :el('sunset').textContent||'‚Äî';
  const illum=(data.moonIllumination||0)*100;
  el('moon-illum').textContent=isFinite(illum)?illum.toFixed(0)+'%':'‚Äî';
  el('moon-phase-pill').textContent=phaseName(data.moonPhaseIndex??data.moonPhase);
  el('solunar-note').textContent=`Solunar: ${data.dayRating||''} ‚Ä¢ Moon: ${phaseName(data.moonPhaseIndex??data.moonPhase)} (${(illum||0).toFixed(0)}% illuminated)`;
}
function renderWeather(data){
  if(!data?.hourly?.time?.length) return;
  const {hourly,daily,minutely_15}=data;
  el('updated-weather').textContent='Updated '+new Date().toLocaleTimeString();

  // table
  const tbody=el('wxTable').querySelector('tbody'); tbody.innerHTML='';
  const rows=hourly.time.map((t,i)=>({t,temp:hourly.temperature_2m[i],wind:hourly.wind_speed_10m[i],gust:hourly.wind_gusts_10m[i],dir:hourly.wind_direction_10m?.[i],rh:hourly.relative_humidity_2m?.[i],pop:hourly.precipitation_probability?.[i]}));
  rows.slice(0,12).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmtTime(r.t)}</td><td>${r.temp?.toFixed?.(1)}</td><td>${r.wind?.toFixed?.(0)}</td><td>${r.gust?.toFixed?.(0)}</td><td>${r.dir??'‚Äî'}</td><td>${r.rh??'‚Äî'}</td><td>${r.pop??'‚Äî'}</td>`;
    tbody.appendChild(tr);
  });

  // charts
  destroyCharts();
  const labels=rows.slice(0,24).map(r=>new Date(r.t).toLocaleTimeString([], {hour:'2-digit'}));
  wxChart=new Chart(document.getElementById('wxChart'),{
    type:'line', data:{labels,datasets:[{label:'Temp ¬∞C',data:rows.slice(0,24).map(r=>r.temp),yAxisID:'y'},{label:'Wind km/h',data:rows.slice(0,24).map(r=>r.wind),yAxisID:'y1'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{title:{display:true,text:'¬∞C'}},y1:{position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'km/h'}}}}
  });

  const pTimes=minutely_15?.time||[], pVals=minutely_15?.precipitation||[];
  if(pTimes.length){
    precipChart=new Chart(document.getElementById('precip15Chart'),{
      type:'bar', data:{labels:pTimes.slice(0,8).map(t=>new Date(t).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})), datasets:[{label:'Precip mm (15 min)', data:pVals.slice(0,8)}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });
    el('updated-precip').textContent='Updated '+new Date().toLocaleTimeString();
  }

  // quick read
  const nowT=rows[0]?.temp, nowW=rows[0]?.wind;
  const bft=beaufortFromKmh(nowW||0);
  el('quickRead').textContent=`Temp ${Number(nowT).toFixed(1)}¬∞C ‚Ä¢ Wind ${Number(nowW).toFixed(0)} km/h (Bft ${bft.scale}: ${bft.name}) ‚Ä¢ UV max ${daily.uv_index_max?.[0] ?? '‚Äî'}`;
}
function beaufortFromKmh(kmh){
  const b=[1,5,11,19,28,38,49,61,74,88,102,117,1000];
  const n=['Calm','Light air','Light breeze','Gentle breeze','Moderate','Fresh','Strong','Near gale','Gale','Strong gale','Storm','Violent storm','Hurricane'];
  let i=b.findIndex(x=>kmh<=x); if(i<0) i=b.length-1; return {scale:i,name:n[i]};
}
function renderMarine(data){
  if(!data?.hourly?.time?.length) return;
  const {hourly}=data;
  el('updated-marine').textContent='Updated '+new Date().toLocaleTimeString();

  const tbody=el('marineTable').querySelector('tbody'); tbody.innerHTML='';
  const rows=hourly.time.map((t,i)=>({t,hs:hourly.wave_height[i],tp:hourly.wave_period[i],dir:hourly.wave_direction[i],wh:hourly.wind_wave_height?.[i],wt:hourly.wind_wave_period?.[i],wd:hourly.wind_wave_direction?.[i],sh:hourly.swell_wave_height?.[i],st:hourly.swell_wave_period?.[i],sd:hourly.swell_wave_direction?.[i]}));
  rows.slice(0,12).forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmtTime(r.t)}</td><td>${r.hs?.toFixed?.(2)}</td><td>${r.tp?.toFixed?.(1)}</td><td>${r.dir?.toFixed?.(0)}</td>`; tbody.appendChild(tr);});

  if(waveChart){try{waveChart.destroy()}catch{}}
  const labels=rows.slice(0,24).map(r=>new Date(r.t).toLocaleTimeString([], {hour:'2-digit'}));
  waveChart=new Chart(document.getElementById('waveChart'),{
    type:'line', data:{labels,datasets:[{label:'Hs m',data:rows.slice(0,24).map(r=>r.hs),yAxisID:'y'},{label:'Period s',data:rows.slice(0,24).map(r=>r.tp),yAxisID:'y1'}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,title:{display:true,text:'m'}},y1:{beginAtZero:true,position:'right',grid:{drawOnChartArea:false},title:{display:true,text:'s'}}}}
  });

  if(waveBreakChart){try{waveBreakChart.destroy()}catch{}}
  waveBreakChart=new Chart(document.getElementById('waveBreakChart'),{
    type:'line', data:{labels,datasets:[{label:'Swell m',data:rows.slice(0,24).map(r=>r.sh)},{label:'Wind-wave m',data:rows.slice(0,24).map(r=>r.wh)}]},
    options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,title:{display:true,text:'m'}}}}
  });

  const br=document.querySelector('#marineBreakTable tbody'); br.innerHTML='';
  rows.slice(0,12).forEach(r=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmtTime(r.t)}</td><td>${r.sh??'‚Äî'}</td><td>${r.st??'‚Äî'}</td><td>${r.wh??'‚Äî'}</td><td>${r.wt??'‚Äî'}</td>`; br.appendChild(tr);});
}
function renderTides(data){
  const tbody=el('tideTable').querySelector('tbody'); tbody.innerHTML='';
  (data.extremes||[]).forEach(x=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${fmtDateTime(x.dt*1000)}</td><td>${x.type}</td><td>${(x.height??0).toFixed(2)}</td>`; tbody.appendChild(tr);});
}

// ====== ORCHESTRATION ======
async function updateAll(){
  updateNow();
  const {lat,lon}=currentLoc();
  el('locName').textContent=el('location').value; el('locCoords').textContent=`${lat.toFixed(4)}, ${lon.toFixed(4)}  (${TZ})`;

  const results=await Promise.allSettled([ getSolunar(lat,lon,toSolunarDate(new Date())), getWeather(lat,lon), getMarine(lat,lon) ]);
  const [solRes,wxRes,marRes]=results;

  if(wxRes.status==='fulfilled'){ try{renderWeather(wxRes.value);}catch(e){console.error('Render weather failed',e);} }
  else { console.error('Weather fetch failed',wxRes.reason); }

  if(marRes.status==='fulfilled'){ try{renderMarine(marRes.value);}catch(e){console.error('Render marine failed',e);} }
  else { console.error('Marine fetch failed',marRes.reason); }

 if (solRes.status === 'fulfilled' && solRes.value) {
  try {
    const sol = solRes.value || {};
    const dISO = toISODate(new Date());
    const payload = {
      major1Start: parseSolunarTime(dISO, sol.major1Start), major1End: parseSolunarTime(dISO, sol.major1Stop),
      major2Start: parseSolunarTime(dISO, sol.major2Start), major2End: parseSolunarTime(dISO, sol.major2Stop),
      minor1Start: parseSolunarTime(dISO, sol.minor1Start), minor1End: parseSolunarTime(dISO, sol.minor1Stop),
      minor2Start: parseSolunarTime(dISO, sol.minor2Start), minor2End: parseSolunarTime(dISO, sol.minor2Stop),
      sunRise: parseSolunarTime(dISO, sol.sunRise), sunSet: parseSolunarTime(dISO, sol.sunSet),
      moonIllumination: (sol.moonIllumination ?? sol.moonPhasePct) / 100,
      moonPhaseIndex: sol.moonPhaseIndex, moonPhase: sol.moonPhase,
      dayRating: sol.dayRating ? `${sol.dayRating}/4` : ''
    };
    if (wxRes.status === 'fulfilled') {
      const wxDaily = wxRes.value.daily;
      if (!payload.sunRise || !payload.sunSet || !isFinite(payload.moonIllumination)) {
        fillFromWeatherDaily(wxDaily);
      }
    }
    renderSolunar(payload);

    // Add status hint if Solunar returned but lacked key times
    if (!payload.major1Start && !payload.major2Start && !payload.minor1Start && !payload.minor2Start) {
      el('solunar-note').textContent = 'Solunar API returned minimal data; showing only what‚Äôs available.';
    }
  } catch (e) {
    console.warn('Solunar render failed', e);
  }
} else {
  try {
    const d = wxRes.status === 'fulfilled' ? wxRes.value.daily : null;
    fillFromWeatherDaily(d);
    el('solunar-note').textContent = 'Solunar API unavailable; showing sunrise/sunset from weather.';
  } catch {}
}

  // Diagnostics
  const diag=[];
  const line=(name,res)=>{ if(!res) return diag.push(`${name}: no result`);
    if(res.status!=='fulfilled') return diag.push(`${name}: FAIL ‚Üí ${String(res.reason)}`);
    return diag.push(`${name}: ok (bytes ~${JSON.stringify(res.value).length})`);
  };
  line('Weather',wxRes); line('Marine',marRes); line('Solunar',solRes);
  console.log('[PLFC diag]',diag.join(' ‚Ä¢ '));

  updateTides();
  recenterMyMaps();
}

async function updateTides(){ try{ const {lat,lon}=currentLoc(); renderTides(await getTides(lat,lon)); }catch(e){ console.warn('Tides unavailable',e); } }

let refreshTimer;
function scheduleAutoRefresh(){ if(refreshTimer) clearInterval(refreshTimer); refreshTimer=setInterval(updateAll, load('plfc.refresh',REFRESH_MS)); }

// Kick it off
updateAll(); scheduleAutoRefresh(); setInterval(updateNow,1000);
</script>

</body>
</html>
