<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PLFC ‚Äì Solunar & Conditions (Point Lookout ‚Ä¢ Amity ‚Ä¢ Dunwich ‚Ä¢ Jumpinpin)</title>
  <meta name="description" content="Single‚Äëfile, host-anywhere solunar and marine conditions app for Minjerribah (North Stradbroke Island) hotspots. 15‚Äëminute auto refresh. All metric." />
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#93a1bd; --text:#e6eefc; --accent:#33d6a6; --warn:#ffb020; --danger:#ff6b6b;
      --border:#1d2840;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,18,32,.98), rgba(11,18,32,.7));backdrop-filter:saturate(1.2) blur(8px);}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .row-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media (max-width:900px){.row,.row-3,.row-4{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:20px;margin:0 0 6px}
    h2{font-size:16px;margin:0 0 8px;color:var(--muted)}
    h3{font-size:14px;margin:0 0 6px;color:var(--muted)}
    .muted{color:var(--muted)}
    select, input, button{background:#0c1529;color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:12px}
    button{cursor:pointer}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--border); background:#0e1a32; font-size:12px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    .kpi{font-size:22px;font-weight:700}
    .kpi-sub{font-size:12px;color:var(--muted)}
    .ok{color:var(--accent)} .warn{color:var(--warn)} .bad{color:var(--danger)}
    .footer{opacity:.7;font-size:12px;text-align:center;padding:20px}
    .tag{font-size:12px;opacity:.9}
    .map-toggle{display:flex;gap:8px;align-items:center; flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .small{font-size:13px}
    .notice{border-left:3px solid var(--accent); padding-left:10px; color:var(--muted)}
    a{color:#7bb6ff}
  </style>
  <!-- Charts (optional, small) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap flex">
      <div>
        <h1>üé£ PLFC Solunar & Conditions</h1>
        <div class="muted small">Point Lookout ‚Ä¢ Amity Point ‚Ä¢ Dunwich ‚Ä¢ Jumpinpin ‚Äî updates every <span id="refresh-interval">15</span> min</div>
      </div>
      <div class="grow"></div>
      <div class="flex">
        <label class="sr-only" for="location">Location</label>
        <select id="location"></select>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="app">
    <div class="row">
      <section class="card">
        <div class="section-title">
          <h2>Google My Maps</h2>
          <div class="map-toggle small">Layer:
            <button class="pill" data-map-layer="all">All</button>
            <button class="pill" data-map-layer="point-lookout">Point Lookout</button>
            <button class="pill" data-map-layer="amity">Amity</button>
            <button class="pill" data-map-layer="dunwich">Dunwich</button>
            <button class="pill" data-map-layer="jumpinpin">Jumpinpin</button>
          </div>
        </div>
        <div class="notice small">This iframe uses a My‚ÄëMaps <em>mid</em>. Replace <code>MY_MAP_ID</code> below with your shared map ID. Layer buttons change the <em>ll</em> and <em>z</em> params to jump around hotspots.</div>
        <div style="aspect-ratio:16/9; margin-top:8px">
          <iframe id="mymaps" title="PLFC Spots" width="100%" height="100%" style="border:0;border-radius:12px" allowfullscreen
            src="https://www.google.com/maps/d/embed?mid=MY_MAP_ID&ehbc=2E312F&ll=-27.4310,153.5470&z=11"></iframe>
        </div>
      </section>

      <section class="card">
        <div class="section-title"><h2>Solunar Bite Windows</h2><span class="pill" id="moon-phase-pill">‚Äî</span></div>
        <div id="solunar">
          <div class="row-4">
            <div>
              <div class="kpi" id="major-1">‚Äî</div>
              <div class="kpi-sub">Major 1</div>
            </div>
            <div>
              <div class="kpi" id="major-2">‚Äî</div>
              <div class="kpi-sub">Major 2</div>
            </div>
            <div>
              <div class="kpi" id="minor-1">‚Äî</div>
              <div class="kpi-sub">Minor 1</div>
            </div>
            <div>
              <div class="kpi" id="minor-2">‚Äî</div>
              <div class="kpi-sub">Minor 2</div>
            </div>
          </div>
          <div class="row-3" style="margin-top:10px">
            <div>
              <div class="kpi" id="sunrise">‚Äî</div>
              <div class="kpi-sub">Sunrise</div>
            </div>
            <div>
              <div class="kpi" id="sunset">‚Äî</div>
              <div class="kpi-sub">Sunset</div>
            </div>
            <div>
              <div class="kpi" id="moon-illum">‚Äî</div>
              <div class="kpi-sub">Moon Illumination</div>
            </div>
          </div>
          <div class="small muted" id="solunar-note" style="margin-top:8px"></div>
        </div>
      </section>
    </div>

    <div class="row" style="margin-top:16px">
      <section class="card">
        <div class="section-title"><h2>Weather & Wind (Open‚ÄëMeteo)</h2><span class="pill" id="updated-weather">‚Äî</span></div>
        <canvas id="wxChart" height="120"></canvas>
        <table id="wxTable" style="margin-top:8px">
          <thead><tr><th>Time</th><th>Temp (¬∞C)</th><th>Wind (km/h)</th><th>Gust (km/h)</th><th>Rain %</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="card">
        <div class="section-title"><h2>Waves (Marine)</h2><span class="pill" id="updated-marine">‚Äî</span></div>
        <canvas id="waveChart" height="120"></canvas>
        <table id="marineTable" style="margin-top:8px">
          <thead><tr><th>Time</th><th>Hs (m)</th><th>Period (s)</th><th>Dir (¬∞)</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </div>

    <div class="row" style="margin-top:16px">
      <section class="card">
        <div class="section-title"><h2>Tides (WorldTides)</h2><span class="pill" id="updated-tides">Requires API key</span></div>
        <div class="flex">
          <input id="worldtidesKey" placeholder="WorldTides API Key (saved locally)" class="grow" />
          <button id="saveKey">Save</button>
        </div>
        <table id="tideTable" style="margin-top:8px">
          <thead><tr><th>Time</th><th>Type</th><th>Height (m)</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="small muted">Tip: get a key at worldtides.info (global predictions). Key is stored in your browser only.</div>
      </section>

      <section class="card">
        <div class="section-title"><h2>Now</h2><span class="pill" id="now-local">‚Äî</span></div>
        <div class="grid">
          <div>
            <h3>Location</h3>
            <div id="locName" class="kpi">‚Äî</div>
            <div class="kpi-sub" id="locCoords">‚Äî</div>
          </div>
          <div>
            <h3>Quick Read</h3>
            <div id="quickRead" class="small"></div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>APIs & Refresh</h2>
      <div class="small muted">We refresh every 15 minutes by default. You can change the interval below.</div>
      <div class="flex" style="margin-top:8px">
        <label>Refresh (minutes): <input id="refreshMins" type="number" min="1" max="60" value="15" style="width:90px"></label>
        <button id="applyRefresh">Apply</button>
      </div>
      <div class="row-4" style="margin-top:10px">
        <div><h3>Solunar</h3><div class="tag"><a target="_blank" href="https://api.solunar.org">api.solunar.org</a> (no key)</div></div>
        <div><h3>Weather</h3><div class="tag"><a target="_blank" href="https://open-meteo.com/">Open‚ÄëMeteo</a> (no key)</div></div>
        <div><h3>Marine</h3><div class="tag"><a target="_blank" href="https://open-meteo.com/en/docs/marine-api">Open‚ÄëMeteo Marine</a> (no key)</div></div>
        <div><h3>Tides</h3><div class="tag"><a target="_blank" href="https://www.worldtides.info/developer">WorldTides</a> (key)</div></div>
      </div>
    </section>

    <div class="footer">Built with ‚ù§Ô∏è for the Point Lookout Fishing Club. Host this single file on GitHub Pages and you're off. ‚Äî Finnius, your Fishing Mate üêü</div>
  </main>

<script>
// ====== CONFIG ======
const LOCATIONS = {
  "Point Lookout": { lat: -27.4310, lon: 153.5347, layer:"point-lookout" },
  "Amity Point":   { lat: -27.4019, lon: 153.4393, layer:"amity" },
  "Dunwich":       { lat: -27.4993, lon: 153.4011, layer:"dunwich" },
  "Jumpinpin":     { lat: -27.7340, lon: 153.4480, layer:"jumpinpin" }
};
const DEFAULT_LOC = "Point Lookout";
const TZ = Intl.DateTimeFormat().resolvedOptions().timeZone || "Australia/Brisbane";
let REFRESH_MS = 15*60*1000; // 15 min

// ====== UTIL ======
const el = (id)=>document.getElementById(id);
const fmtTime = (d)=> new Date(d).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
const fmtDateTime = (d)=> new Date(d).toLocaleString([], {hour:"2-digit", minute:"2-digit", day:"2-digit", month:"short"});
const toISODate = (d)=> new Date(d).toISOString().slice(0,10);
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

function save(key,val){localStorage.setItem(key, JSON.stringify(val));}
function load(key,fb){try{return JSON.parse(localStorage.getItem(key)) ?? fb;}catch{ return fb;}}

// ====== INIT UI ======
(function initUI(){
  const sel = el('location');
  Object.keys(LOCATIONS).forEach(name=>{
    const o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o);
  });
  sel.value = load('plfc.loc', DEFAULT_LOC);
  el('worldtidesKey').value = load('plfc.worldtides','');
  el('refreshMins').value = (load('plfc.refresh', REFRESH_MS)/60000)|0;
  el('refresh-interval').textContent = ((load('plfc.refresh', REFRESH_MS)/60000)|0);
  sel.addEventListener('change', ()=>{ save('plfc.loc', sel.value); updateAll(); recenterMyMaps(); });
  el('saveKey').addEventListener('click', ()=>{ save('plfc.worldtides', el('worldtidesKey').value.trim()); updateTides(); });
  el('applyRefresh').addEventListener('click', ()=>{
    const mins = clamp(parseInt(el('refreshMins').value||'15',10),1,60);
    REFRESH_MS = mins*60*1000; save('plfc.refresh', REFRESH_MS);
    el('refresh-interval').textContent = mins; scheduleAutoRefresh();
  });
  el('refreshBtn').addEventListener('click', ()=>updateAll());
  document.querySelectorAll('[data-map-layer]').forEach(btn=>btn.addEventListener('click',()=>{
    const layer = btn.dataset.mapLayer; centerToLayer(layer);
  }));
})();

function currentLoc(){ return LOCATIONS[el('location').value] }
function updateNow(){ el('now-local').textContent = new Date().toLocaleString(); }

// ====== GOOGLE MY MAPS ======
function recenterMyMaps(){
  const {lat,lon} = currentLoc();
  const url = new URL(el('mymaps').src);
  url.searchParams.set('ll', `${lat.toFixed(5)},${lon.toFixed(5)}`);
  url.searchParams.set('z', '12');
  el('mymaps').src = url.toString();
}
function centerToLayer(layer){
  if(layer==='all'){ el('mymaps').src = el('mymaps').src; return; }
  const entry = Object.entries(LOCATIONS).find(([,v])=>v.layer===layer);
  if(entry){ el('location').value = entry[0]; save('plfc.loc', entry[0]); recenterMyMaps(); updateAll(); }
}

// ====== FETCHERS ======
async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

async function getSolunar(lat,lon,dateISO){
  const base = `https://api.solunar.org/solunar/${lat},${lon},${dateISO},0`;
  return fetchJSON(base);
}

async function getWeather(lat,lon){
  const url = new URL('https://api.open-meteo.com/v1/forecast');
  url.search = new URLSearchParams({ latitude:lat, longitude:lon, timezone: TZ,
    hourly: ['temperature_2m','wind_speed_10m','wind_gusts_10m','precipitation_probability'].join(','),
    daily: ['sunrise','sunset','uv_index_max','moon_phase'].join(',')
  }).toString();
  return fetchJSON(url);
}

async function getMarine(lat,lon){
  const url = new URL('https://marine-api.open-meteo.com/v1/marine');
  url.search = new URLSearchParams({ latitude:lat, longitude:lon, timezone: TZ,
    hourly: ['wave_height','wave_direction','wave_period'].join(',')
  }).toString();
  return fetchJSON(url);
}

async function getTides(lat,lon){
  const key = el('worldtidesKey').value.trim();
  if(!key){ el('updated-tides').textContent = 'Add API key to show tides'; return {extremes:[]}; }
  const url = new URL('https://www.worldtides.info/api');
  url.search = new URLSearchParams({extremes: '', lat:lat, lon:lon, key:key, length: 48*3600}).toString();
  const data = await fetchJSON(url);
  el('updated-tides').textContent = 'Updated ' + new Date(data.creationDate||Date.now()).toLocaleString();
  return data;
}

// ====== RENDER ======
let wxChart, waveChart;
function destroyCharts(){ if(wxChart){wxChart.destroy()} if(waveChart){waveChart.destroy()} }

function renderSolunar(data){
  // data has: sunrise, sunset, moonrise, moonset, major1Start, major1End, minor1Start, etc
  const keys = ['major1Start','major1End','major2Start','major2End','minor1Start','minor1End','minor2Start','minor2End','sunRise','sunSet','moonPhase'];
  keys.forEach(k=>{ if(!(k in data)){/*noop*/} })
  function show(id, start, end){
    const elx = el(id);
    if(start && end){ elx.textContent = fmtTime(start)+ ' ‚Äì ' + fmtTime(end); }
    else { elx.textContent = '‚Äî'; }
  }
  show('major-1', data.major1Start, data.major1End);
  show('major-2', data.major2Start, data.major2End);
  show('minor-1', data.minor1Start, data.minor1End);
  show('minor-2', data.minor2Start, data.minor2End);
  el('sunrise').textContent = data.sunRise ? fmtTime(data.sunRise) : '‚Äî';
  el('sunset').textContent  = data.sunSet ? fmtTime(data.sunSet) : '‚Äî';
  const illum = (data.moonIllumination||0)*100;
  el('moon-illum').textContent = isFinite(illum) ? illum.toFixed(0)+'%' : '‚Äî';
  el('moon-phase-pill').textContent = phaseName(data.moonPhaseIndex ?? data.moonPhase);
  el('solunar-note').textContent = `Solunar: ${data.dayRating||''} ‚Ä¢ Moon: ${phaseName(data.moonPhaseIndex ?? data.moonPhase)} (${(illum||0).toFixed(0)}% illuminated)`;
}

function phaseName(idx){
  // api.solunar.org returns textual in moonPhase, sometimes index in moonPhaseIndex
  if(typeof idx === 'string') return idx;
  const names = ['New','Waxing Crescent','First Quarter','Waxing Gibbous','Full','Waning Gibbous','Last Quarter','Waning Crescent'];
  return names[clamp(Math.round(idx||0),0,7)] || '‚Äî';
}

function renderWeather(data){
  const { hourly, daily } = data;
  el('updated-weather').textContent = 'Updated ' + new Date().toLocaleTimeString();
  const tbody = el('wxTable').querySelector('tbody');
  tbody.innerHTML = '';
  const rows = hourly.time.map((t,i)=>({
    t, temp: hourly.temperature_2m[i], wind: hourly.wind_speed_10m[i], gust: hourly.wind_gusts_10m[i], pop: hourly.precipitation_probability?.[i]
  }));
  const next12 = rows.slice(0, 12);
  next12.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${fmtTime(r.t)}</td><td>${r.temp?.toFixed?.(1)}</td><td>${(r.wind*3.6/1).toFixed(0)}</td><td>${(r.gust*3.6/1).toFixed(0)}</td><td>${r.pop ?? '‚Äî'}</td>`; // wind m/s -> km/h
    tbody.appendChild(tr);
  });

  // Chart: temp & wind
  const ctx = document.getElementById('wxChart');
  const labels = rows.slice(0,24).map(r=> new Date(r.t).toLocaleTimeString([], {hour:'2-digit'}) );
  const temps = rows.slice(0,24).map(r=> r.temp );
  const winds = rows.slice(0,24).map(r=> (r.wind*3.6) );
  destroyCharts();
  wxChart = new Chart(ctx, { type:'line', data:{ labels,
      datasets:[
        {label:'Temp ¬∞C', data:temps, yAxisID:'y'},
        {label:'Wind km/h', data:winds, yAxisID:'y1'}
      ]}, options:{ responsive:true, maintainAspectRatio:false,
        scales:{ y:{ beginAtZero:false, title:{display:true,text:'¬∞C'} }, y1:{ beginAtZero:true, position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'km/h'} } }
      }
  });

  // quick read
  const nowT = temps[0]; const nowW = winds[0];
  el('quickRead').textContent = `Temp ${nowT?.toFixed?.(1)}¬∞C ‚Ä¢ Wind ${nowW?.toFixed?.(0)} km/h ‚Ä¢ UV max ${daily.uv_index_max?.[0] ?? '‚Äî'}`;
}

function renderMarine(data){
  const { hourly } = data;
  el('updated-marine').textContent = 'Updated ' + new Date().toLocaleTimeString();
  const tbody = el('marineTable').querySelector('tbody'); tbody.innerHTML='';
  const rows = hourly.time.map((t,i)=>({ t, hs: hourly.wave_height[i], tp: hourly.wave_period[i], dir: hourly.wave_direction[i] }));
  const next12 = rows.slice(0,12);
  next12.forEach(r=>{
    const tr=document.createElement('tr'); tr.innerHTML = `<td>${fmtTime(r.t)}</td><td>${r.hs?.toFixed?.(2)}</td><td>${r.tp?.toFixed?.(1)}</td><td>${r.dir?.toFixed?.(0)}</td>`; tbody.appendChild(tr);
  });
  const ctx = document.getElementById('waveChart');
  const labels = rows.slice(0,24).map(r=> new Date(r.t).toLocaleTimeString([], {hour:'2-digit'}) );
  const hs = rows.slice(0,24).map(r=> r.hs );
  const tp = rows.slice(0,24).map(r=> r.tp );
  waveChart = new Chart(ctx, { type:'line', data:{ labels,
    datasets:[ {label:'Hs m', data:hs, yAxisID:'y'}, {label:'Period s', data:tp, yAxisID:'y1'} ] }, options:{ responsive:true, maintainAspectRatio:false,
      scales:{ y:{ beginAtZero:true, title:{display:true,text:'m'} }, y1:{ beginAtZero:true, position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'s'} } }
    }
  });
}

function renderTides(data){
  const tbody = el('tideTable').querySelector('tbody'); tbody.innerHTML='';
  (data.extremes||[]).forEach(x=>{
    const tr=document.createElement('tr'); tr.innerHTML = `<td>${fmtDateTime(x.dt*1000)}</td><td>${x.type}</td><td>${(x.height??0).toFixed(2)}</td>`; tbody.appendChild(tr);
  });
}

// ====== ORCHESTRATION ======
async function updateAll(){
  updateNow();
  const {lat,lon} = currentLoc();
  el('locName').textContent = el('location').value; el('locCoords').textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}  (${TZ})`;
  try{
    const [sol, wx, mar] = await Promise.all([
      getSolunar(lat,lon,toISODate(new Date())),
      getWeather(lat,lon),
      getMarine(lat,lon)
    ]);
    // adapt solunar response into our renderer shape
    renderSolunar({
      major1Start: sol.major1Start? new Date(`${sol.date} ${sol.major1Start}`):null,
      major1End:   sol.major1Stop?  new Date(`${sol.date} ${sol.major1Stop}`):null,
      major2Start: sol.major2Start? new Date(`${sol.date} ${sol.major2Start}`):null,
      major2End:   sol.major2Stop?  new Date(`${sol.date} ${sol.major2Stop}`):null,
      minor1Start: sol.minor1Start? new Date(`${sol.date} ${sol.minor1Start}`):null,
      minor1End:   sol.minor1Stop?  new Date(`${sol.date} ${sol.minor1Stop}`):null,
      minor2Start: sol.minor2Start? new Date(`${sol.date} ${sol.minor2Start}`):null,
      minor2End:   sol.minor2Stop?  new Date(`${sol.date} ${sol.minor2Stop}`):null,
      sunRise: sol.sunRise? new Date(`${sol.date} ${sol.sunRise}`):null,
      sunSet:  sol.sunSet?  new Date(`${sol.date} ${sol.sunSet}`):null,
      moonIllumination: (sol.moonIllumination ?? sol.moonPhasePct)/100,
      moonPhaseIndex: sol.moonPhaseIndex,
      moonPhase: sol.moonPhase,
      dayRating: sol.dayRating? `${sol.dayRating}/4` : ''
    });
    renderWeather(wx);
    renderMarine(mar);
  }catch(e){ console.error(e); alert('Failed to fetch weather/solunar/marine. Try refresh.'); }

  updateTides();
  recenterMyMaps();
}

async function updateTides(){
  try{
    const {lat,lon} = currentLoc();
    const t = await getTides(lat,lon);
    renderTides(t);
  }catch(e){ console.warn('Tides unavailable', e); }
}

let refreshTimer; 
function scheduleAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(updateAll, load('plfc.refresh', REFRESH_MS));
}

// Kick it off
updateAll();
scheduleAutoRefresh();
setInterval(updateNow, 1000);

</script>
</body>
</html>
